<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>CAVE Query: Synaptic Connectivity – MICrONs Tutorial</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-9eb995e8644016eb670a0cb3bf478a26.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../styles.css">
<meta property="og:title" content="CAVE Query: Synaptic Connectivity – MICrONs Tutorial">
<meta property="og:description" content="">
<meta property="og:image" content="https://tutorial.microns-explorer.org/quickstart_notebooks/04-cave-query-synapses_files/figure-html/cell-14-output-2.png">
<meta property="og:site_name" content="MICrONs Tutorial">
<meta property="og:image:height" content="668">
<meta property="og:image:width" content="782">
</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">MICrONs Tutorial</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../introduction.html"> 
<span class="menu-text">Introduction</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.microns-explorer.org/"> 
<span class="menu-text">Microns Explorer</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../analysis_gallery/index.html"> 
<span class="menu-text">Analysis Gallery</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../faq.html"> 
<span class="menu-text">FAQ</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.nature.com/collections/bdigiaicbd"> 
<span class="menu-text">Nature Publications</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
    <div class="dropdown">
      <a href="" title="" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" role="link" aria-label=""><i class="bi bi-chat-left-text-fill"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item quarto-navbar-tools-item" href="https://github.com/AllenInstitute/microns_tutorial/discussions">
            Forum
            </a>
          </li>
      </ul>
    </div>
    <div class="dropdown">
      <a href="" title="" id="quarto-navigation-tool-dropdown-1" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" role="link" aria-label=""><i class="bi bi-github"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-1">
          <li>
            <a class="dropdown-item quarto-navbar-tools-item" href="https://github.com/AllenInstitute/microns_tutorial">
            Source Code
            </a>
          </li>
          <li>
            <a class="dropdown-item quarto-navbar-tools-item" href="https://github.com/AllenInstitute/microns_tutorial/issues">
            Report a Bug
            </a>
          </li>
      </ul>
    </div>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../python-tools.html">Python Tools</a></li><li class="breadcrumb-item"><a href="../quickstart_notebooks/04-cave-query-synapses.html">CAVE Query: Synaptic Connectivity</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../background.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Background</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../dataset-basics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Dataset Basics</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Versioning and Data Quality</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../proofreading.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Proofreading and Data Quality</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../materialization-version.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Materialization and Versioning</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../vortex-overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Virtual Observatory of the Cortex (VORTEX)</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Online Tools</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../neuroglancer-basic.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Neuroglancer</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../dash-table-viewer.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Dash Apps: Table Viewer</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../dash-connectivity.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Dash Apps: Connectivity Viewer</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../python-tools.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Python Tools</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../quickstart_notebooks/01-caveclient-setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">CAVEclient Setup</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../quickstart_notebooks/02-cave-query-cell-types.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">CAVE Query: Cell Types</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../quickstart_notebooks/03-cave-query-proofread-cells.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">CAVE Query: Proofread Cells</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../quickstart_notebooks/04-cave-query-synapses.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">CAVE Query: Synaptic Connectivity</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../quickstart_notebooks/05-cloudvolume-download.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Download Imagery and Segmentation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../quickstart_notebooks/06-cloudvolume-download-mesh.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Download Meshes</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../quickstart_notebooks/07-cave-download-skeleton.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Download Skeletons</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../quickstart_notebooks/08-standard-transform.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Standard Transform: Coordinate System</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../quickstart_notebooks/09-nglui-neuroglancer.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">NGLui: Neuroglancer States</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Data Inventory</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="false">
 <span class="menu-text">Release Manifests</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../release_manifests/version-1300.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">1300 (Jan 2025)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../release_manifests/version-1181.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">1181 (Sep 2024)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../release_manifests/version-1078.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">1078 (Jun 2024)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../release_manifests/version-943.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">943 (Jan 2024)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../release_manifests/version-795.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">795 (Aug 2023)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../release_manifests/version-661.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">661 (Jun 2023)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../release_manifests/version-343.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">343 (Feb 2022)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../release_manifests/version-117.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">117 (Jun 2021)</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../annotation-tables.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Annotation Tables</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../static-repositories.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Static Repositories</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#initialize-caveclient-with-a-datastack" id="toc-initialize-caveclient-with-a-datastack" class="nav-link active" data-scroll-target="#initialize-caveclient-with-a-datastack">Initialize CAVEclient with a datastack</a>
  <ul class="collapse">
  <li><a href="#materialization-versions" id="toc-materialization-versions" class="nav-link" data-scroll-target="#materialization-versions">Materialization versions</a></li>
  </ul></li>
  <li><a href="#querying-synapses" id="toc-querying-synapses" class="nav-link" data-scroll-target="#querying-synapses">Querying Synapses</a>
  <ul class="collapse">
  <li><a href="#query-synapses-given-pt_root_id-of-interest" id="toc-query-synapses-given-pt_root_id-of-interest" class="nav-link" data-scroll-target="#query-synapses-given-pt_root_id-of-interest">Query synapses given <code>pt_root_id</code> of interest</a></li>
  <li><a href="#query-synapses-given-bounding_box-of-interest" id="toc-query-synapses-given-bounding_box-of-interest" class="nav-link" data-scroll-target="#query-synapses-given-bounding_box-of-interest">Query synapses given <code>bounding_box</code> of interest</a></li>
  </ul></li>
  <li><a href="#query-proofread-cells-and-connectivity" id="toc-query-proofread-cells-and-connectivity" class="nav-link" data-scroll-target="#query-proofread-cells-and-connectivity">Query proofread cells and connectivity</a>
  <ul class="collapse">
  <li><a href="#proofread-neurons" id="toc-proofread-neurons" class="nav-link" data-scroll-target="#proofread-neurons">Proofread neurons</a></li>
  <li><a href="#query-synapses-between-proofread-neurons" id="toc-query-synapses-between-proofread-neurons" class="nav-link" data-scroll-target="#query-synapses-between-proofread-neurons">Query synapses between proofread neurons</a></li>
  <li><a href="#plot-connectivity-as-binarized-heatmap" id="toc-plot-connectivity-as-binarized-heatmap" class="nav-link" data-scroll-target="#plot-connectivity-as-binarized-heatmap">Plot connectivity as binarized heatmap</a></li>
  </ul></li>
  <li><a href="#add-cell-type-information-to-connectivity" id="toc-add-cell-type-information-to-connectivity" class="nav-link" data-scroll-target="#add-cell-type-information-to-connectivity">Add cell type information to connectivity</a>
  <ul class="collapse">
  <li><a href="#querying-cell-type-information" id="toc-querying-cell-type-information" class="nav-link" data-scroll-target="#querying-cell-type-information">Querying cell type information</a></li>
  <li><a href="#sorting-the-synapse-matrix-with-cell-types" id="toc-sorting-the-synapse-matrix-with-cell-types" class="nav-link" data-scroll-target="#sorting-the-synapse-matrix-with-cell-types">Sorting the synapse matrix with cell types</a></li>
  <li><a href="#plot-cell-connectivity-sorted-by-cell-type" id="toc-plot-cell-connectivity-sorted-by-cell-type" class="nav-link" data-scroll-target="#plot-cell-connectivity-sorted-by-cell-type">Plot cell connectivity, sorted by cell type</a></li>
  </ul></li>
  <li><a href="#aggregate-connectivity-across-cell-types" id="toc-aggregate-connectivity-across-cell-types" class="nav-link" data-scroll-target="#aggregate-connectivity-across-cell-types">Aggregate connectivity across cell types</a>
  <ul class="collapse">
  <li><a href="#merge-cell-types-to-synapse-table" id="toc-merge-cell-types-to-synapse-table" class="nav-link" data-scroll-target="#merge-cell-types-to-synapse-table">Merge cell types to synapse table</a></li>
  <li><a href="#pivot-the-synapse-table-to-collect-cell-type-connectivity" id="toc-pivot-the-synapse-table-to-collect-cell-type-connectivity" class="nav-link" data-scroll-target="#pivot-the-synapse-table-to-collect-cell-type-connectivity">Pivot the synapse table to collect cell type connectivity</a></li>
  <li><a href="#plot-cell-connectivity-aggregated-by-cell-type" id="toc-plot-cell-connectivity-aggregated-by-cell-type" class="nav-link" data-scroll-target="#plot-cell-connectivity-aggregated-by-cell-type">Plot cell connectivity, aggregated by cell type</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.dev/AllenInstitute/microns_tutorial/blob/main/tutorial_book/quickstart_notebooks/04-cave-query-synapses.ipynb" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/AllenInstitute/microns_tutorial/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div><div class="quarto-code-links"><h2>Code Links</h2><ul><li><a href="https://github.com/AllenInstitute/microns_tutorial/tree/main/tutorial_book/quickstart_notebooks"><i class="bi bi-file-code"></i>Download Quickstart Notebooks</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../python-tools.html">Python Tools</a></li><li class="breadcrumb-item"><a href="../quickstart_notebooks/04-cave-query-synapses.html">CAVE Query: Synaptic Connectivity</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">CAVE Query: Synaptic Connectivity</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>The <strong>Connectome Annotation Versioning Engine (CAVE)</strong> is a suite of tools developed at the Allen Institute and Seung Lab to manage large connectomics data.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Initial Setup
</div>
</div>
<div class="callout-body-container callout-body">
<p>Before using any programmatic access to the data, <a href="em_py_01_caveclient_setup.html">you first need to set up your CAVEclient token</a>.</p>
</div>
</div>
<p>The connectome data (synapses, cell types, etc.) can be accessed from the cloud via CAVE. However, because of the size of the connectivity tables, it is often preferable to download and compile the features of interest (in this case synapses) to work with offline. This notebook steps through downloading the synapses of the proofread neurons, as of materialization version 1300.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Quickstart
</div>
</div>
<div class="callout-body-container callout-body">
<p>It is recommended you have worked through the <a href="em_py_02_cave_quickstart.html">CAVE Quickstart</a> notebook, as this tutorial builds on knowledge in the previous notebook.</p>
</div>
</div>
<section id="initialize-caveclient-with-a-datastack" class="level2">
<h2 class="anchored" data-anchor-id="initialize-caveclient-with-a-datastack">Initialize CAVEclient with a datastack</h2>
<p>Datasets in CAVE are organized as datastacks. These are a combination of an EM dataset, a segmentation and a set of annotations. The datastack for MICrONS public release is <code>minnie65_public</code>. When you instantiate your client with this datastack, it loads all relevant information to access it.</p>
<div id="379742b9" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib <span class="im">import</span> pyplot <span class="im">as</span> plt</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> caveclient <span class="im">import</span> CAVEclient</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>client <span class="op">=</span> CAVEclient(<span class="st">"minnie65_public"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="materialization-versions" class="level3">
<h3 class="anchored" data-anchor-id="materialization-versions">Materialization versions</h3>
<p>Data in CAVE is timestamped and periodically versioned - each (materialization) version corresponds to a specific timestamp. Individual versions are made publicly available. The Materialization client allows one to interact with the materialized annotation tables that were posted to the annotation service. These are called <strong>queries</strong> to the dataset, and available from <code>client.materialize</code>. For more, see the <a href="https://caveconnectome.github.io/CAVEclient/tutorials/materialization/">CAVEclient Documentation</a>.</p>
<p>Periodic updates are made to the public datastack, which will include updates to the available tables. Some cells will have different <code>pt_root_id</code> because they have undergone <a href="../proofreading.html">proofreading</a>.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>For analysis consistency, is worth checking the version of the data you are using, and consider specifying the version with <code>client.version = your_version</code></p>
<p>Read more about <a href="..\materialization-version.html#how-to-set-the-version-of-your-analysis">setting the version of your analysis</a></p>
</div>
</div>
<div id="468594d9" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>client.materialize.get_versions()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="2">
<pre><code>[1300, 1078, 117, 661, 343, 1181, 795, 943]</code></pre>
</div>
</div>
<p>And these are their associated timestamps (all timestamps are in UTC):</p>
<div id="846b1129" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> version <span class="kw">in</span> client.materialize.get_versions():</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Version </span><span class="sc">{</span>version<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>client<span class="sc">.</span>materialize<span class="sc">.</span>get_timestamp(version)<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Version 1300: 2025-01-13 10:10:01.286229+00:00
Version 1078: 2024-06-05 10:10:01.203215+00:00
Version 117: 2021-06-11 08:10:00.215114+00:00
Version 661: 2023-04-06 20:17:09.199182+00:00
Version 343: 2022-02-24 08:10:00.184668+00:00
Version 1181: 2024-09-16 10:10:01.121167+00:00
Version 795: 2023-08-23 08:10:01.404268+00:00
Version 943: 2024-01-22 08:10:01.497934+00:00</code></pre>
</div>
</div>
<p>The client will automatically query the latest materialization version. You can specify a <code>materialization_version</code> for every query if you want to access a specific version.</p>
<div id="27bf81de-8698-4911-af8f-5979ff562425" class="cell" data-tags="[]" data-execution_count="4">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># set materialization version, for consistency</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>client.version <span class="op">=</span> <span class="dv">1300</span> <span class="co"># current public as of 1/13/2025</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="querying-synapses" class="level2">
<h2 class="anchored" data-anchor-id="querying-synapses">Querying Synapses</h2>
<p>While synapses are stored as any other table in the database, in this case <code>synapses_pni_2</code>, this table is much larger than any other table at more than 337 million rows:</p>
<div id="f23bcfb9-5da2-4abc-b5ef-a6151262a76b" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>client.materialize.get_annotation_count(<span class="st">'synapses_pni_2'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>337312429</code></pre>
</div>
</div>
<p>While we can query the synapse table directly, this is generally not recommended. It is too large to query all at once. CAVE limits to queries to 500,000 rows at once and will display a warning when that happens. Here, we demonstrate this with the limit set to 10:</p>
<div id="6b1000ad-f707-4e11-89c1-f8cb954c196d" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>synapse_table_name <span class="op">=</span> client.info.get_datastack_info()[<span class="st">"synapse_table"</span>]</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>syn_df <span class="op">=</span> client.materialize.query_table(synapse_table_name, limit<span class="op">=</span><span class="dv">10</span>, desired_resolution<span class="op">=</span>[<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>], split_positions<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>syn_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">created</th>
<th data-quarto-table-cell-role="th">superceded_id</th>
<th data-quarto-table-cell-role="th">valid</th>
<th data-quarto-table-cell-role="th">pre_pt_position_x</th>
<th data-quarto-table-cell-role="th">pre_pt_position_y</th>
<th data-quarto-table-cell-role="th">pre_pt_position_z</th>
<th data-quarto-table-cell-role="th">post_pt_position_x</th>
<th data-quarto-table-cell-role="th">post_pt_position_y</th>
<th data-quarto-table-cell-role="th">post_pt_position_z</th>
<th data-quarto-table-cell-role="th">ctr_pt_position_x</th>
<th data-quarto-table-cell-role="th">ctr_pt_position_y</th>
<th data-quarto-table-cell-role="th">ctr_pt_position_z</th>
<th data-quarto-table-cell-role="th">size</th>
<th data-quarto-table-cell-role="th">pre_pt_supervoxel_id</th>
<th data-quarto-table-cell-role="th">pre_pt_root_id</th>
<th data-quarto-table-cell-role="th">post_pt_supervoxel_id</th>
<th data-quarto-table-cell-role="th">post_pt_root_id</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>482324897</td>
<td>2020-11-04 06:48:58.343057+00:00</td>
<td>NaN</td>
<td>t</td>
<td>1476448.0</td>
<td>850856.0</td>
<td>620360.0</td>
<td>1476288.0</td>
<td>850376.0</td>
<td>620400.0</td>
<td>1476192.0</td>
<td>850648.0</td>
<td>620360.0</td>
<td>2976</td>
<td>115495518947404152</td>
<td>864691135035312593</td>
<td>115495450227928501</td>
<td>864691134965890572</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>111356912</td>
<td>2020-11-04 06:48:58.343057+00:00</td>
<td>NaN</td>
<td>t</td>
<td>591184.0</td>
<td>555056.0</td>
<td>675880.0</td>
<td>591104.0</td>
<td>555408.0</td>
<td>675960.0</td>
<td>591152.0</td>
<td>555200.0</td>
<td>676000.0</td>
<td>2976</td>
<td>85086257273159206</td>
<td>864691135557293342</td>
<td>85086257339729644</td>
<td>864691137053640566</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>219362361</td>
<td>2020-11-04 06:48:58.343057+00:00</td>
<td>NaN</td>
<td>t</td>
<td>865496.0</td>
<td>482488.0</td>
<td>662320.0</td>
<td>864912.0</td>
<td>482048.0</td>
<td>661920.0</td>
<td>865192.0</td>
<td>482288.0</td>
<td>662000.0</td>
<td>2976</td>
<td>94513263810944271</td>
<td>864691135595450728</td>
<td>94513195091453796</td>
<td>864691135204272683</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>350226388</td>
<td>2020-11-04 06:48:58.343057+00:00</td>
<td>NaN</td>
<td>t</td>
<td>1173304.0</td>
<td>349688.0</td>
<td>992960.0</td>
<td>1173240.0</td>
<td>349448.0</td>
<td>992800.0</td>
<td>1173232.0</td>
<td>349616.0</td>
<td>992840.0</td>
<td>2976</td>
<td>105064109745413552</td>
<td>864691136216863455</td>
<td>105064109745412680</td>
<td>864691136774161774</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>292350246</td>
<td>2020-11-04 06:48:58.343057+00:00</td>
<td>NaN</td>
<td>t</td>
<td>1029376.0</td>
<td>421024.0</td>
<td>1059200.0</td>
<td>1029232.0</td>
<td>421336.0</td>
<td>1058880.0</td>
<td>1029336.0</td>
<td>421280.0</td>
<td>1059040.0</td>
<td>2976</td>
<td>100140703036155312</td>
<td>864691135628516419</td>
<td>100140703036140569</td>
<td>864691132041695465</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>164940667</td>
<td>2020-11-04 06:48:58.343057+00:00</td>
<td>NaN</td>
<td>t</td>
<td>728984.0</td>
<td>575104.0</td>
<td>620400.0</td>
<td>729032.0</td>
<td>574904.0</td>
<td>620040.0</td>
<td>729072.0</td>
<td>574824.0</td>
<td>620400.0</td>
<td>2976</td>
<td>89801650193255101</td>
<td>864691135375598409</td>
<td>89801650193247746</td>
<td>864691136175511558</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>261934954</td>
<td>2020-11-04 06:48:58.343057+00:00</td>
<td>NaN</td>
<td>t</td>
<td>960512.0</td>
<td>747088.0</td>
<td>778120.0</td>
<td>960600.0</td>
<td>747560.0</td>
<td>778400.0</td>
<td>960600.0</td>
<td>747352.0</td>
<td>778280.0</td>
<td>2976</td>
<td>97759091191496793</td>
<td>864691136296744475</td>
<td>97759091258050193</td>
<td>864691135404420078</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>47809213</td>
<td>2020-11-04 06:48:58.343057+00:00</td>
<td>NaN</td>
<td>t</td>
<td>443488.0</td>
<td>848552.0</td>
<td>684400.0</td>
<td>443848.0</td>
<td>848512.0</td>
<td>684600.0</td>
<td>443576.0</td>
<td>848496.0</td>
<td>684440.0</td>
<td>2976</td>
<td>80029534644397607</td>
<td>864691135585163343</td>
<td>80029534644408014</td>
<td>864691135379785202</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>65519860</td>
<td>2020-11-04 06:48:58.343057+00:00</td>
<td>NaN</td>
<td>t</td>
<td>500232.0</td>
<td>633600.0</td>
<td>1039280.0</td>
<td>500424.0</td>
<td>633344.0</td>
<td>1038960.0</td>
<td>500380.0</td>
<td>633448.0</td>
<td>1039080.0</td>
<td>5960</td>
<td>81992645077294792</td>
<td>864691136156246677</td>
<td>81992645077283850</td>
<td>864691136817302638</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>446835682</td>
<td>2020-11-04 06:48:58.343057+00:00</td>
<td>NaN</td>
<td>t</td>
<td>1401536.0</td>
<td>596288.0</td>
<td>708680.0</td>
<td>1401744.0</td>
<td>596096.0</td>
<td>708720.0</td>
<td>1401648.0</td>
<td>596136.0</td>
<td>708520.0</td>
<td>2976</td>
<td>112953654491063415</td>
<td>864691136538026146</td>
<td>112953654491055747</td>
<td>864691134020263786</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Instead, you have several options for querying cells of interest:</p>
<ul>
<li>Specifying the <code>pre_ids</code></li>
<li>Specifying the <code>post_ids</code></li>
<li>Searching within a <code>bounding_box</code></li>
<li>Using a combination of the above to iterate through large numbers of neurons</li>
</ul>
<section id="query-synapses-given-pt_root_id-of-interest" class="level3">
<h3 class="anchored" data-anchor-id="query-synapses-given-pt_root_id-of-interest">Query synapses given <code>pt_root_id</code> of interest</h3>
<p>The <code>synapse_query</code> function allows you to query the synapse table in a more convenient way than most other tables. In particular, the <code>pre_ids</code> and <code>post_ids</code> let you specify which root id (or collection of root ids) you want to query, with pre_ids indicating the collection of <strong>presynaptic neurons</strong> and post_ids the collection of <strong>postsynaptic neurons</strong>.</p>
<p>Using both <code>pre_ids</code> and <code>post_ids</code> in one call is effectively a logical AND, returning only those synapses from neurons in the list of <code>pre_ids</code> that target neurons in the list of <code>post_ids</code>.</p>
<p>Let’s look at one particular example.</p>
<div id="2aabf10f-79ef-4ed5-bc5f-d749205664cf" class="cell" data-tags="[&quot;remove-stderr&quot;]" data-execution_count="7">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Pick example cell</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>example_root_id <span class="op">=</span> <span class="dv">864691135808473885</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Query synapse table with synapse_query()</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>input_syn_df <span class="op">=</span> client.materialize.synapse_query(post_ids<span class="op">=</span>example_root_id)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total number of input synapses for </span><span class="sc">{</span>example_root_id<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span><span class="bu">len</span>(input_syn_df)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>input_syn_df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Total number of input synapses for 864691135808473885: 4628</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="7">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">created</th>
<th data-quarto-table-cell-role="th">superceded_id</th>
<th data-quarto-table-cell-role="th">valid</th>
<th data-quarto-table-cell-role="th">size</th>
<th data-quarto-table-cell-role="th">pre_pt_supervoxel_id</th>
<th data-quarto-table-cell-role="th">pre_pt_root_id</th>
<th data-quarto-table-cell-role="th">post_pt_supervoxel_id</th>
<th data-quarto-table-cell-role="th">post_pt_root_id</th>
<th data-quarto-table-cell-role="th">pre_pt_position</th>
<th data-quarto-table-cell-role="th">post_pt_position</th>
<th data-quarto-table-cell-role="th">ctr_pt_position</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>165943687</td>
<td>2020-11-04 06:48:59.403833+00:00</td>
<td>NaN</td>
<td>t</td>
<td>6068</td>
<td>89667372671545980</td>
<td>864691135522708676</td>
<td>89667372671554898</td>
<td>864691135808473885</td>
<td>[181250, 191912, 18361]</td>
<td>[181278, 191844, 18364]</td>
<td>[181276, 191873, 18366]</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>155169887</td>
<td>2020-11-04 06:49:11.336675+00:00</td>
<td>NaN</td>
<td>t</td>
<td>964</td>
<td>88540717118418517</td>
<td>864691135412525042</td>
<td>88540717051854108</td>
<td>864691135808473885</td>
<td>[172816, 186434, 19971]</td>
<td>[172892, 186468, 19969]</td>
<td>[172821, 186483, 19965]</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>175655972</td>
<td>2020-11-04 06:48:59.403833+00:00</td>
<td>NaN</td>
<td>t</td>
<td>260</td>
<td>90230391344454185</td>
<td>864691136711146862</td>
<td>90160022600247406</td>
<td>864691135808473885</td>
<td>[184962, 192380, 18359]</td>
<td>[184836, 192448, 18366]</td>
<td>[184916, 192396, 18359]</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>159676064</td>
<td>2020-11-04 06:48:59.876707+00:00</td>
<td>NaN</td>
<td>t</td>
<td>14460</td>
<td>89385691939052008</td>
<td>864691135773033723</td>
<td>89385691939060896</td>
<td>864691135808473885</td>
<td>[178870, 190176, 21429]</td>
<td>[178870, 190204, 21437]</td>
<td>[178878, 190132, 21434]</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>169597812</td>
<td>2020-11-04 06:49:11.962249+00:00</td>
<td>NaN</td>
<td>t</td>
<td>7164</td>
<td>89598584945119102</td>
<td>864691135459877874</td>
<td>89598584945109756</td>
<td>864691135808473885</td>
<td>[180636, 203654, 21957]</td>
<td>[180706, 203762, 21963]</td>
<td>[180680, 203716, 21959]</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="fa8ae5fa-c482-4dc7-b76e-d8392fea03fe" class="cell" data-tags="[&quot;remove-stderr&quot;]" data-execution_count="8">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Query synapse table with synapse_query()</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>output_syn_df <span class="op">=</span> client.materialize.synapse_query(pre_ids<span class="op">=</span>example_root_id)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total number of output synapses for </span><span class="sc">{</span>example_root_id<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span><span class="bu">len</span>(output_syn_df)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>output_syn_df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Total number of output synapses for 864691135808473885: 1498</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="8">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">created</th>
<th data-quarto-table-cell-role="th">superceded_id</th>
<th data-quarto-table-cell-role="th">valid</th>
<th data-quarto-table-cell-role="th">size</th>
<th data-quarto-table-cell-role="th">pre_pt_supervoxel_id</th>
<th data-quarto-table-cell-role="th">pre_pt_root_id</th>
<th data-quarto-table-cell-role="th">post_pt_supervoxel_id</th>
<th data-quarto-table-cell-role="th">post_pt_root_id</th>
<th data-quarto-table-cell-role="th">pre_pt_position</th>
<th data-quarto-table-cell-role="th">post_pt_position</th>
<th data-quarto-table-cell-role="th">ctr_pt_position</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>162136319</td>
<td>2020-11-04 14:43:13.226680+00:00</td>
<td>NaN</td>
<td>t</td>
<td>2064</td>
<td>89174654291344339</td>
<td>864691135808473885</td>
<td>89174654291351817</td>
<td>864691136057875416</td>
<td>[177614, 190930, 19985]</td>
<td>[177692, 190868, 19997]</td>
<td>[177678, 190900, 19993]</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>158405512</td>
<td>2020-11-04 06:48:59.403833+00:00</td>
<td>NaN</td>
<td>t</td>
<td>420</td>
<td>89385416926790697</td>
<td>864691135808473885</td>
<td>89385416926797494</td>
<td>864691135546540484</td>
<td>[179076, 188248, 20233]</td>
<td>[179156, 188220, 20239]</td>
<td>[179140, 188230, 20239]</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>185549462</td>
<td>2020-11-04 06:49:10.903020+00:00</td>
<td>NaN</td>
<td>t</td>
<td>4832</td>
<td>91356016507479890</td>
<td>864691135808473885</td>
<td>91356016507470163</td>
<td>864691135884799088</td>
<td>[193168, 190452, 19262]</td>
<td>[193142, 190404, 19257]</td>
<td>[193180, 190432, 19254]</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>138110803</td>
<td>2020-11-04 06:49:46.758528+00:00</td>
<td>NaN</td>
<td>t</td>
<td>3176</td>
<td>87263084540201919</td>
<td>864691135808473885</td>
<td>87263084540199587</td>
<td>864691135060075931</td>
<td>[163440, 104292, 19808]</td>
<td>[163498, 104348, 19806]</td>
<td>[163460, 104356, 19804]</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>157378264</td>
<td>2020-11-04 07:38:27.332669+00:00</td>
<td>NaN</td>
<td>t</td>
<td>412</td>
<td>89374490395905686</td>
<td>864691135808473885</td>
<td>89374490395921430</td>
<td>864691135446953106</td>
<td>[179218, 107132, 19372]</td>
<td>[179204, 107010, 19383]</td>
<td>[179196, 107072, 19380]</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Note that synapse queries always return the list of every synapse between the neurons in the query, even if there are multiple synapses between the same pair of neurons.</p>
<p>A common pattern to generate a list of connections between unique pairs of neurons is to group by the root ids of the presynaptic and postsynaptic neurons and then count the number of synapses between them. For example, use <code>pandas.groupby()</code> to get the number of synapses from this neuron onto every other neuron:</p>
<div id="f3cb7983-a67f-4a46-8063-e88724ab4086" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get count of synapses between presynaptic and postsynaptic partners</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>output_syn_df.groupby(</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  [<span class="st">'pre_pt_root_id'</span>, <span class="st">'post_pt_root_id'</span>]</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>).count()[[<span class="st">'id'</span>]].rename(</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  columns<span class="op">=</span>{<span class="st">'id'</span>: <span class="st">'syn_count'</span>}</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>).sort_values(</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  by<span class="op">=</span><span class="st">'syn_count'</span>,</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  ascending<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Note that the 'id' part here is just a way to quickly extract one column. This could be any of the remaining column names, </span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="co"># but `id` is often convenient because it is common to all tables.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">syn_count</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">pre_pt_root_id</th>
<th data-quarto-table-cell-role="th">post_pt_root_id</th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td rowspan="11" data-quarto-table-cell-role="th" data-valign="top">864691135808473885</td>
<td data-quarto-table-cell-role="th">864691135280056225</td>
<td>20</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">864691135617649257</td>
<td>16</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">864691134949547516</td>
<td>15</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">864691135784316467</td>
<td>13</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">864691136275521549</td>
<td>11</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">864691136913679601</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">864691136923311076</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">864691136923570404</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">864691136924123364</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">864691136973673244</td>
<td>1</td>
</tr>
</tbody>
</table>

<p>1035 rows × 1 columns</p>
</div>
</div>
</div>
</section>
<section id="query-synapses-given-bounding_box-of-interest" class="level3">
<h3 class="anchored" data-anchor-id="query-synapses-given-bounding_box-of-interest">Query synapses given <code>bounding_box</code> of interest</h3>
<p>The <code>synapse_query()</code> can find all synapses in an arbitrary space of the volume. This is useful if, for example, you want to find all synapses in a radius around one synapse of interest, such as for building a null-model of connectivity based on proximity.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>bounding_box <span class="op">=</span> [[min_x, min_y, min_z], [max_x, max_y, max_z]]</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>df<span class="op">=</span>client.materialize.query_table(post_ids <span class="op">=</span> example_root_id,</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>                                  bounding_box<span class="op">=</span>bounding_box)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>For more details, see the <a href="https://caveconnectome.github.io/CAVEclient/tutorials/materialization/#synapse-query">CAVEclient documentation</a>. Also compare to bounding box downloads through cloud-volume in the <a href="05-cloudvolume-download.html">next quickstart notebooks</a>.</p>
</section>
</section>
<section id="query-proofread-cells-and-connectivity" class="level2">
<h2 class="anchored" data-anchor-id="query-proofread-cells-and-connectivity">Query proofread cells and connectivity</h2>
<section id="proofread-neurons" class="level3">
<h3 class="anchored" data-anchor-id="proofread-neurons">Proofread neurons</h3>
<p>The table <code>proofreading_status_and_strategy</code> contains proofreading information about ~2000 neurons. For more on interpretting and using the proofreading table, see <a href="03-cave-query-proofread-cells.html">the previous quickstart notebook</a>.</p>
<p>Here we query all neurons in the dataset that have proofread axons</p>
<div id="97152d2a-bc1a-4235-bf99-90e4c248ab48" class="cell" data-tags="[]" data-execution_count="10">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>proof_df <span class="op">=</span> client.materialize.tables.proofreading_status_and_strategy(status_axon<span class="op">=</span><span class="st">'t'</span>).query(desired_resolution<span class="op">=</span>[<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>], split_positions<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>proof_df[<span class="st">"strategy_axon"</span>].value_counts()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>strategy_axon
axon_partially_extended    1459
axon_interareal             130
axon_fully_extended         127
none                          7
Name: count, dtype: int64</code></pre>
</div>
</div>
</section>
<section id="query-synapses-between-proofread-neurons" class="level3">
<h3 class="anchored" data-anchor-id="query-synapses-between-proofread-neurons">Query synapses between proofread neurons</h3>
<p>We can query the graph spanned by the neurons with proofread axons using synapse query.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Here we specify both the <code>pre_ids</code> and <code>post_ids</code>, meaning we will only be interpretting the connectivity between cells that <strong>both have proofread axons</strong>. This makes plotting the square connectivity matrix easier.</p>
<p>However, connectivity between two cells is generally interpretable even if only the <strong>presynaptic cell has axon proofreading</strong>. Meaning, you can remove the <code>post_ids</code> argument in the section below, and still have interpretable data.</p>
</div>
</div>
<div id="dd7bd406-c4f0-4ccf-a005-8c226cc12be6" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="co"># This takes 3-5 minutes to complete</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>syn_proof_only_df <span class="op">=</span> client.materialize.synapse_query(pre_ids<span class="op">=</span>proof_df.pt_root_id,</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>                                                  post_ids<span class="op">=</span>proof_df.pt_root_id,</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>                                                  remove_autapses<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>                                                 )</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">len</span>(syn_proof_only_df))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>158931
CPU times: total: 609 ms
Wall time: 3min 25s</code></pre>
</div>
</div>
</section>
<section id="plot-connectivity-as-binarized-heatmap" class="level3">
<h3 class="anchored" data-anchor-id="plot-connectivity-as-binarized-heatmap">Plot connectivity as binarized heatmap</h3>
<p>Now lets plot the connectivity between every proofread cell and every other cell. This uses the <code>pandas.pivot_table()</code> to turn the long-form synapse table into a connectivity matrix.</p>
<div id="0c1cf99b-c035-4650-b51c-c306abed8471" class="cell" data-tags="[]" data-execution_count="12">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="co"># This takes 2 minutes to complete</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>syn_mat <span class="op">=</span> syn_proof_only_df.pivot_table(index<span class="op">=</span><span class="st">"pre_pt_root_id"</span>, </span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>                                        columns<span class="op">=</span><span class="st">"post_pt_root_id"</span>, </span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>                                        values<span class="op">=</span><span class="st">"size"</span>, </span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>                                        aggfunc<span class="op">=</span><span class="kw">lambda</span> x: <span class="bu">float</span>(np.<span class="bu">sum</span>(x) <span class="op">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>                                       ).fillna(<span class="dv">0</span>)</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>syn_mat <span class="op">=</span> syn_mat.reindex(columns<span class="op">=</span>np.array(syn_mat.index))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: total: 1min 4s
Wall time: 2min 6s</code></pre>
</div>
</div>
<p>Plot the binarized connectivity with Seaborn <code>heatmap()</code>:</p>
<div id="27d3ab35-9951-4dd0-822c-0ceb487be345" class="cell" data-tags="[]" data-execution_count="43">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">7</span>, <span class="dv">5</span>), dpi<span class="op">=</span><span class="dv">150</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>sns.heatmap(syn_mat, cmap<span class="op">=</span><span class="st">"gray_r"</span>, xticklabels<span class="op">=</span>[], yticklabels<span class="op">=</span>[], </span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>            ax<span class="op">=</span>ax, square<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>            cbar_kws<span class="op">=</span>{<span class="st">"label"</span>: <span class="st">"Connected - binary"</span>})</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Connectivity between proofread cells'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="43">
<pre><code>Text(0.5, 1.0, 'Connectivity between proofread cells')</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="04-cave-query-synapses_files/figure-html/cell-14-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>There is some structure of highly interconnected cells. By adding information about the type of cells, we might infer more about the connectivity patterns</p>
</section>
</section>
<section id="add-cell-type-information-to-connectivity" class="level2">
<h2 class="anchored" data-anchor-id="add-cell-type-information-to-connectivity">Add cell type information to connectivity</h2>
<section id="querying-cell-type-information" class="level3">
<h3 class="anchored" data-anchor-id="querying-cell-type-information">Querying cell type information</h3>
<p>There are two distinct ways cell types were classified in the MICrONS dataset: manual and automated. Manual annotations are available for ~1,000 neurons (<code>allen_v1_column_types_slanted_ref</code>), automated classifications are available for all cell bodies based on these manual annotations (<code>aibs_metamodel_celltypes_v661</code>). For more about querying cell types tables, see the <a href="02-cave-query-cell-types.html">previous quickstart notebook</a>.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>For more on cell types and how to interpret them, see the <a href="..\annotation-tables.html#cell-type-tables">Annotation Tables</a> page.</p>
</div>
</div>
<div id="14a088a8" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>ct_manual_df <span class="op">=</span> client.materialize.tables.allen_v1_column_types_slanted_ref().query()</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="co"># rename the reference column for clarity</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>ct_manual_df.rename(columns<span class="op">=</span>{<span class="st">'target_id'</span>: <span class="st">'nucleus_id'</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="co"># remove segments with multiple cell bodies</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>ct_manual_df.drop_duplicates(<span class="st">"pt_root_id"</span>, keep<span class="op">=</span><span class="va">False</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>ct_manual_df.head(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">created</th>
<th data-quarto-table-cell-role="th">valid</th>
<th data-quarto-table-cell-role="th">volume</th>
<th data-quarto-table-cell-role="th">pt_supervoxel_id</th>
<th data-quarto-table-cell-role="th">pt_root_id</th>
<th data-quarto-table-cell-role="th">id_ref</th>
<th data-quarto-table-cell-role="th">created_ref</th>
<th data-quarto-table-cell-role="th">valid_ref</th>
<th data-quarto-table-cell-role="th">nucleus_id</th>
<th data-quarto-table-cell-role="th">classification_system</th>
<th data-quarto-table-cell-role="th">cell_type</th>
<th data-quarto-table-cell-role="th">pt_position</th>
<th data-quarto-table-cell-role="th">bb_start_position</th>
<th data-quarto-table-cell-role="th">bb_end_position</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>258319</td>
<td>2020-09-28 22:40:42.476911+00:00</td>
<td>t</td>
<td>261.806162</td>
<td>89309001002848425</td>
<td>864691136021936376</td>
<td>50</td>
<td>2023-03-18 14:13:21.613360+00:00</td>
<td>t</td>
<td>258319</td>
<td>aibs_coarse_excitatory</td>
<td>23P</td>
<td>[178400, 143248, 21238]</td>
<td>[nan, nan, nan]</td>
<td>[nan, nan, nan]</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>276438</td>
<td>2020-09-28 22:40:42.700226+00:00</td>
<td>t</td>
<td>277.317714</td>
<td>89465269428261699</td>
<td>864691136487559186</td>
<td>1119</td>
<td>2023-03-18 14:13:22.506660+00:00</td>
<td>t</td>
<td>276438</td>
<td>aibs_coarse_excitatory</td>
<td>6P-CT</td>
<td>[179648, 258768, 23597]</td>
<td>[nan, nan, nan]</td>
<td>[nan, nan, nan]</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>260552</td>
<td>2020-09-28 22:40:42.745779+00:00</td>
<td>t</td>
<td>230.111805</td>
<td>89170256379033022</td>
<td>864691135784109363</td>
<td>35</td>
<td>2023-03-18 14:13:21.602813+00:00</td>
<td>t</td>
<td>260552</td>
<td>aibs_coarse_excitatory</td>
<td>23P</td>
<td>[177408, 157968, 21002]</td>
<td>[nan, nan, nan]</td>
<td>[nan, nan, nan]</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>260263</td>
<td>2020-09-28 22:40:42.746658+00:00</td>
<td>t</td>
<td>274.324193</td>
<td>88044356338331571</td>
<td>864691135694415551</td>
<td>95</td>
<td>2023-03-18 14:13:21.644304+00:00</td>
<td>t</td>
<td>260263</td>
<td>aibs_coarse_excitatory</td>
<td>23P</td>
<td>[169440, 158128, 20266]</td>
<td>[nan, nan, nan]</td>
<td>[nan, nan, nan]</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>262898</td>
<td>2020-09-28 22:40:42.749245+00:00</td>
<td>t</td>
<td>230.092308</td>
<td>88468836747612860</td>
<td>864691135759892302</td>
<td>81</td>
<td>2023-03-18 14:13:21.634505+00:00</td>
<td>t</td>
<td>262898</td>
<td>aibs_coarse_inhibitory</td>
<td>BPC</td>
<td>[172512, 175280, 21964]</td>
<td>[nan, nan, nan]</td>
<td>[nan, nan, nan]</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>This table is a reference on the <code>nucleus_detection_v0</code> table, and adds two additional data columns: <code>classification_system</code> and <code>cell_type</code>. The <code>classification_system</code> divides the cells into excitatitory and inhibitory neurons as well as non-neuronal cells. <code>cell_type</code> provides lower level cell annotations.</p>
<p>Next, we query the automatically classified cell type information. The query works the same way:</p>
<div id="403c0d36" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>ct_auto_df <span class="op">=</span> client.materialize.tables.aibs_metamodel_celltypes_v661().query()</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="co"># rename the reference column for clarity</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>ct_auto_df.rename(columns<span class="op">=</span>{<span class="st">'target_id'</span>: <span class="st">'nucleus_id'</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="co"># remove segments with multiple cell bodies</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>ct_auto_df.drop_duplicates(<span class="st">"pt_root_id"</span>, keep<span class="op">=</span><span class="va">False</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>ct_auto_df.head(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">created</th>
<th data-quarto-table-cell-role="th">valid</th>
<th data-quarto-table-cell-role="th">volume</th>
<th data-quarto-table-cell-role="th">pt_supervoxel_id</th>
<th data-quarto-table-cell-role="th">pt_root_id</th>
<th data-quarto-table-cell-role="th">id_ref</th>
<th data-quarto-table-cell-role="th">created_ref</th>
<th data-quarto-table-cell-role="th">valid_ref</th>
<th data-quarto-table-cell-role="th">nucleus_id</th>
<th data-quarto-table-cell-role="th">classification_system</th>
<th data-quarto-table-cell-role="th">cell_type</th>
<th data-quarto-table-cell-role="th">pt_position</th>
<th data-quarto-table-cell-role="th">bb_start_position</th>
<th data-quarto-table-cell-role="th">bb_end_position</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>336365</td>
<td>2020-09-28 22:42:48.966292+00:00</td>
<td>t</td>
<td>272.488202</td>
<td>93606511657924288</td>
<td>864691136274724621</td>
<td>36916</td>
<td>2023-12-19 22:47:18.659864+00:00</td>
<td>t</td>
<td>336365</td>
<td>excitatory_neuron</td>
<td>5P-IT</td>
<td>[209760, 180832, 27076]</td>
<td>[nan, nan, nan]</td>
<td>[nan, nan, nan]</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>110648</td>
<td>2020-09-28 22:45:09.650639+00:00</td>
<td>t</td>
<td>328.533443</td>
<td>79385153184885329</td>
<td>864691135489403194</td>
<td>1070</td>
<td>2023-12-19 22:38:00.472115+00:00</td>
<td>t</td>
<td>110648</td>
<td>excitatory_neuron</td>
<td>23P</td>
<td>[106448, 129632, 25410]</td>
<td>[nan, nan, nan]</td>
<td>[nan, nan, nan]</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>112071</td>
<td>2020-09-28 22:43:34.088785+00:00</td>
<td>t</td>
<td>272.929423</td>
<td>79035988248401958</td>
<td>864691136147292311</td>
<td>1099</td>
<td>2023-12-19 22:38:00.898837+00:00</td>
<td>t</td>
<td>112071</td>
<td>excitatory_neuron</td>
<td>23P</td>
<td>[103696, 149472, 15583]</td>
<td>[nan, nan, nan]</td>
<td>[nan, nan, nan]</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>197927</td>
<td>2020-09-28 22:43:10.652649+00:00</td>
<td>t</td>
<td>91.308851</td>
<td>84529699506051734</td>
<td>864691136050858227</td>
<td>13259</td>
<td>2023-12-19 22:41:14.417986+00:00</td>
<td>t</td>
<td>197927</td>
<td>nonneuron</td>
<td>oligo</td>
<td>[143600, 186192, 26471]</td>
<td>[nan, nan, nan]</td>
<td>[nan, nan, nan]</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>198087</td>
<td>2020-09-28 22:41:36.677186+00:00</td>
<td>t</td>
<td>161.744978</td>
<td>83756261929388963</td>
<td>864691135809440972</td>
<td>13271</td>
<td>2023-12-19 22:41:14.685474+00:00</td>
<td>t</td>
<td>198087</td>
<td>nonneuron</td>
<td>astrocyte</td>
<td>[137952, 190944, 27361]</td>
<td>[nan, nan, nan]</td>
<td>[nan, nan, nan]</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="30bd4ea3" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>ct_auto_df[<span class="st">"classification_system"</span>].value_counts()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>classification_system
excitatory_neuron    63757
nonneuron            18699
inhibitory_neuron     7847
Name: count, dtype: int64</code></pre>
</div>
</div>
<div id="81dea009" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>ct_auto_df[<span class="st">"cell_type"</span>].value_counts()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>cell_type
23P          19642
4P           14720
6P-IT        11637
5P-IT         7889
astrocyte     7108
oligo         6900
6P-CT         6755
BC            3309
MC            2433
microglia     2394
5P-ET         2157
BPC           1484
OPC           1451
5P-NP          957
pericyte       846
NGC            621
Name: count, dtype: int64</code></pre>
</div>
</div>
<p>We can merge the <strong>manual</strong> and <strong>automatic</strong> cell types together into a single cell type table for convenience, using <code>pandas.merge()</code> on shared columns <code>[pt_root_id, nucleus_id]</code>. Here we perform an <code>outer</code> merge to keep rows that exist in either table.</p>
<div id="09408d70-97b1-4654-8d46-a08ef8ea3e1d" class="cell" data-tags="[]" data-execution_count="18">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>ct_all_df <span class="op">=</span> (pd.merge(ct_auto_df[[<span class="st">'pt_root_id'</span>,<span class="st">'classification_system'</span>,<span class="st">'cell_type'</span>, <span class="st">'nucleus_id'</span>]],</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>                     ct_manual_df[[<span class="st">'pt_root_id'</span>,<span class="st">'classification_system'</span>,<span class="st">'cell_type'</span>,<span class="st">'nucleus_id'</span>]],</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>                     on<span class="op">=</span>[<span class="st">'pt_root_id'</span>,<span class="st">'nucleus_id'</span>],</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>                     how<span class="op">=</span><span class="st">'outer'</span>,</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>                     suffixes<span class="op">=</span>[<span class="st">'_auto'</span>,<span class="st">'_manual'</span>],</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>             .fillna({<span class="st">'cell_type_auto'</span>: <span class="st">'unknown'</span>,</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>                      <span class="st">'classification_system_auto'</span>: <span class="st">'unknown'</span>,</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>                      <span class="st">'cell_type_manual'</span>: <span class="st">'unknown'</span>,</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>                      <span class="st">'classification_system_manual '</span>: <span class="st">'unknown'</span>,}</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>ct_all_df.tail()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">pt_root_id</th>
<th data-quarto-table-cell-role="th">classification_system_auto</th>
<th data-quarto-table-cell-role="th">cell_type_auto</th>
<th data-quarto-table-cell-role="th">nucleus_id</th>
<th data-quarto-table-cell-role="th">classification_system_manual</th>
<th data-quarto-table-cell-role="th">cell_type_manual</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">90328</td>
<td>864691137199039297</td>
<td>excitatory_neuron</td>
<td>23P</td>
<td>293714</td>
<td>NaN</td>
<td>unknown</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">90329</td>
<td>864691137199050049</td>
<td>excitatory_neuron</td>
<td>4P</td>
<td>194481</td>
<td>NaN</td>
<td>unknown</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">90330</td>
<td>864691137199094593</td>
<td>excitatory_neuron</td>
<td>23P</td>
<td>361383</td>
<td>NaN</td>
<td>unknown</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">90331</td>
<td>864691137199115073</td>
<td>excitatory_neuron</td>
<td>4P</td>
<td>260071</td>
<td>NaN</td>
<td>unknown</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">90332</td>
<td>864691137199116097</td>
<td>inhibitory_neuron</td>
<td>BC</td>
<td>372402</td>
<td>NaN</td>
<td>unknown</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="sorting-the-synapse-matrix-with-cell-types" class="level3">
<h3 class="anchored" data-anchor-id="sorting-the-synapse-matrix-with-cell-types">Sorting the synapse matrix with cell types</h3>
<p>Let’s combine the synaptic connecitivity with the cell type information. Below we provide logic for sorting a connectivity matrix using a list of labels.</p>
<p>This example looks at the connectivity among: <strong>proofread excitatory cells in the V1 column</strong> . Using <code>proofreading_status_and_strategy</code> and <code>allen_v1_column_types_slanted_ref</code> to filter the connectivity. The same approach can be used for all cells in the dataset by substituting the <code>cell_type_auto</code> label from <code>aibs_metamodel_celltypes_v661</code>.</p>
<div id="c34c5f6d-6cb3-4eb7-8124-4d1378558bd0" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sort_matrix_by_types(mat: pd.DataFrame, </span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>                         labels: pd.DataFrame, </span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>                         label_type_col: <span class="bu">str</span> <span class="op">=</span> <span class="st">"cell_type_auto"</span>, </span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>                         label_id_col: <span class="bu">str</span> <span class="op">=</span> <span class="st">"pt_root_id"</span>, </span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>                         post_labels: pd.DataFrame <span class="op">=</span> <span class="va">None</span>, </span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>                         post_label_type_col: <span class="bu">str</span> <span class="op">=</span> <span class="va">None</span>, </span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>                         post_label_id_col: <span class="bu">str</span> <span class="op">=</span> <span class="va">None</span>):</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Sorts (synapse) matrix by labels.</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="co">    This function assumes a square synapse matrix!</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a><span class="co">        mat: synapse matrix as pandas DataFrame</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a><span class="co">        labels: DataFrame with labels, e.g. the output of client.materialize.query_table('aibs_metamodel_celltypes_v661')</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a><span class="co">        label_type_col: column name in labels for cell types</span></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a><span class="co">        label_id_col: column name in labels for root ids</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a><span class="co">        post_labels: DataFrame with labels, e.g. the output of client.materialize.query_table('aibs_metamodel_celltypes_v661')</span></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a><span class="co">        post_label_type_col: column name in labels for cell types</span></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a><span class="co">        post_label_id_col: column name in labels for root ids</span></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a><span class="co">        mat_sorted: sorted matrix</span></span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a><span class="co">        mat_labels: sorted labels; has the same length as matrix</span></span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> post_labels <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>        post_labels <span class="op">=</span> labels</span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> post_label_type_col <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>        post_label_type_col <span class="op">=</span> label_type_col</span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> post_label_id_col <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a>        post_label_id_col <span class="op">=</span> label_id_col</span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>    mat_sorted <span class="op">=</span> mat.copy()</span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a>    pre_mat_labels <span class="op">=</span> np.array(labels.set_index(label_id_col).loc[mat_sorted.index][label_type_col])</span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a>    pre_sorting <span class="op">=</span> np.argsort(pre_mat_labels)</span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a>    post_mat_labels <span class="op">=</span> np.array(post_labels.set_index(post_label_id_col).loc[mat_sorted.T.index][post_label_type_col])</span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a>    post_sorting <span class="op">=</span> np.argsort(post_mat_labels)</span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a>    mat_sorted <span class="op">=</span> mat_sorted.iloc[pre_sorting].T.iloc[post_sorting].T</span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> mat_sorted, pre_mat_labels[pre_sorting], post_mat_labels[post_sorting]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="d64020ea-0af4-4968-8eda-e8f350ae7030" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Select the proofread, manually-identified excitatory cells</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>manual_exc_root_ids <span class="op">=</span> ct_all_df.query(<span class="st">"classification_system_manual=='aibs_coarse_excitatory'"</span>).pt_root_id.to_numpy()</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the proofread synapses by the excitatory cells</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>exc_syn_df <span class="op">=</span> syn_proof_only_df.loc[(syn_proof_only_df.pre_pt_root_id.isin(manual_exc_root_ids) <span class="op">&amp;</span> </span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>                                    syn_proof_only_df.post_pt_root_id.isin(manual_exc_root_ids) </span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>                                   )]</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Pivot synapse matrix</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>exc_syn_mat <span class="op">=</span> (exc_syn_df.pivot_table(index<span class="op">=</span><span class="st">"pre_pt_root_id"</span>, </span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>                                     columns<span class="op">=</span><span class="st">"post_pt_root_id"</span>, </span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>                                     values<span class="op">=</span><span class="st">"size"</span>, </span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>                                     aggfunc<span class="op">=</span><span class="kw">lambda</span> x: <span class="bu">float</span>(np.<span class="bu">sum</span>(x) <span class="op">&gt;</span> <span class="dv">0</span>)).fillna(<span class="dv">0</span>)</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>              )</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>exc_syn_mat <span class="op">=</span> exc_syn_mat.reindex(columns<span class="op">=</span>np.array(exc_syn_mat.index))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="f9355785-a89c-4fcb-80c3-1d3ede258089" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># sort the matrix by cell types to render sensibly in heatmap</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>syn_mat_ct, syn_mat_cell_types, _ <span class="op">=</span> sort_matrix_by_types(exc_syn_mat, ct_all_df, label_type_col<span class="op">=</span><span class="st">"cell_type_manual"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="plot-cell-connectivity-sorted-by-cell-type" class="level3">
<h3 class="anchored" data-anchor-id="plot-cell-connectivity-sorted-by-cell-type">Plot cell connectivity, sorted by cell type</h3>
<div id="fa4de0e3-b2b8-458c-b1a3-58bb45c9b69a" class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="co"># add colormap for cell type</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>cts, ct_idx <span class="op">=</span> np.unique(syn_mat_cell_types, return_inverse<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>ct_colors <span class="op">=</span> plt.get_cmap(<span class="st">"tab10"</span>)(ct_idx)</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">7</span>, <span class="dv">5</span>), dpi<span class="op">=</span><span class="dv">150</span>)</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>sns.heatmap(syn_mat_ct, cmap<span class="op">=</span><span class="st">"gray_r"</span>, xticklabels<span class="op">=</span>[], yticklabels<span class="op">=</span>[], </span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>            ax<span class="op">=</span>ax, square<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>            cbar_kws<span class="op">=</span>{<span class="st">"label"</span>: <span class="st">"Connected - binary"</span>})</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a><span class="co"># add row and column colors for cell types</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, color <span class="kw">in</span> <span class="bu">enumerate</span>(ct_colors):</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>    ax.add_patch(plt.Rectangle(xy<span class="op">=</span>(<span class="op">-</span><span class="fl">0.01</span>, i), width<span class="op">=</span><span class="fl">0.01</span>, height<span class="op">=</span><span class="dv">1</span>, color<span class="op">=</span>color, lw<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>                               transform<span class="op">=</span>ax.get_yaxis_transform(), clip_on<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, color <span class="kw">in</span> <span class="bu">enumerate</span>(ct_colors):</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>    ax.add_patch(plt.Rectangle(xy<span class="op">=</span>(i, <span class="dv">1</span>), height<span class="op">=</span><span class="fl">0.01</span>, width<span class="op">=</span><span class="dv">1</span>, color<span class="op">=</span>color, lw<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>                               transform<span class="op">=</span>ax.get_xaxis_transform(), clip_on<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a><span class="co"># add a legend for the cell types</span></span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>legend_elements <span class="op">=</span> [matplotlib.lines.Line2D([<span class="dv">0</span>], [<span class="dv">0</span>], color<span class="op">=</span>plt.get_cmap(<span class="st">"tab10"</span>)(i), label<span class="op">=</span>ct) <span class="cf">for</span> i, ct <span class="kw">in</span> <span class="bu">enumerate</span>(cts)]</span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>plt.legend(handles<span class="op">=</span>legend_elements, loc<span class="op">=</span><span class="st">'upper left'</span>, bbox_to_anchor<span class="op">=</span>(<span class="fl">1.3</span>, <span class="dv">1</span>), title<span class="op">=</span><span class="st">"cell types"</span>)</span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Connectivity between proofread excitatory cells </span><span class="ch">\n</span><span class="st"> (cell type manually labeled)'</span>)</span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="04-cave-query-synapses_files/figure-html/cell-23-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="aggregate-connectivity-across-cell-types" class="level2">
<h2 class="anchored" data-anchor-id="aggregate-connectivity-across-cell-types">Aggregate connectivity across cell types</h2>
<p>Sometimes it is more useful to consider connectivity between groups of cells, rather than individual cells–especially as the number of indivudal cells soars into the thousands. In this example we will aggregate synaptic connectivity to broad cell types.</p>
<section id="merge-cell-types-to-synapse-table" class="level3">
<h3 class="anchored" data-anchor-id="merge-cell-types-to-synapse-table">Merge cell types to synapse table</h3>
<p>Here, we can assign a cell type to the pre-synaptic and post-synaptic root id on the connectivity matrix. Given the established <code>syn_proof_only_df</code> and the merged cell type table <code>ct_all_df</code>, let’s consider the connectivity between manually identified cell types:</p>
<div id="98655954-f264-49db-a7dd-7106264c99ea" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge the cell types to the presynaptic cell id</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>syn_proof_ct_df <span class="op">=</span> ( syn_proof_only_df.merge(</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    ct_all_df[[<span class="st">'pt_root_id'</span>,<span class="st">'cell_type_manual'</span>]], </span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    left_on<span class="op">=</span><span class="st">'pre_pt_root_id'</span>, </span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    right_on<span class="op">=</span><span class="st">'pt_root_id'</span>,</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">'left'</span> )</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>.rename(columns<span class="op">=</span>{<span class="st">'cell_type_manual'</span>: <span class="st">'cell_type_pre'</span>})</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>.drop(columns<span class="op">=</span>[<span class="st">'pt_root_id'</span>])</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge the cell types to the postsynaptic cell id</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>syn_proof_ct_df <span class="op">=</span> ( syn_proof_ct_df.merge(</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>    ct_all_df[[<span class="st">'pt_root_id'</span>,<span class="st">'cell_type_manual'</span>]], </span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>    left_on<span class="op">=</span><span class="st">'post_pt_root_id'</span>, </span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>    right_on<span class="op">=</span><span class="st">'pt_root_id'</span>,</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">'left'</span> )</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>.rename(columns<span class="op">=</span>{<span class="st">'cell_type_manual'</span>: <span class="st">'cell_type_post'</span>})</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>.drop(columns<span class="op">=</span>[<span class="st">'pt_root_id'</span>])</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>syn_proof_ct_df.head(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="28">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">created</th>
<th data-quarto-table-cell-role="th">superceded_id</th>
<th data-quarto-table-cell-role="th">valid</th>
<th data-quarto-table-cell-role="th">size</th>
<th data-quarto-table-cell-role="th">pre_pt_supervoxel_id</th>
<th data-quarto-table-cell-role="th">pre_pt_root_id</th>
<th data-quarto-table-cell-role="th">post_pt_supervoxel_id</th>
<th data-quarto-table-cell-role="th">post_pt_root_id</th>
<th data-quarto-table-cell-role="th">pre_pt_position</th>
<th data-quarto-table-cell-role="th">post_pt_position</th>
<th data-quarto-table-cell-role="th">ctr_pt_position</th>
<th data-quarto-table-cell-role="th">cell_type_pre</th>
<th data-quarto-table-cell-role="th">cell_type_post</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>152094175</td>
<td>2020-11-04 07:20:36.943498+00:00</td>
<td>NaN</td>
<td>t</td>
<td>14020</td>
<td>88401010355440214</td>
<td>864691135778700477</td>
<td>88401010355435596</td>
<td>864691135561699041</td>
<td>[171952, 194076, 19787]</td>
<td>[171996, 194038, 19786]</td>
<td>[172002, 194074, 19793]</td>
<td>23P</td>
<td>MC</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>148367619</td>
<td>2020-11-04 11:46:41.982682+00:00</td>
<td>NaN</td>
<td>t</td>
<td>4880</td>
<td>88187223727657156</td>
<td>864691136057875416</td>
<td>88187223727666196</td>
<td>864691135659200386</td>
<td>[170264, 174184, 17059]</td>
<td>[170378, 174182, 17060]</td>
<td>[170300, 174144, 17052]</td>
<td>unknown</td>
<td>unknown</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>174979485</td>
<td>2020-11-04 08:50:39.220791+00:00</td>
<td>NaN</td>
<td>t</td>
<td>4688</td>
<td>90161191099360974</td>
<td>864691136057875416</td>
<td>90161191099310671</td>
<td>864691136674495623</td>
<td>[184770, 200984, 19986]</td>
<td>[184786, 201052, 19972]</td>
<td>[184816, 200974, 19981]</td>
<td>unknown</td>
<td>5P-IT</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="pivot-the-synapse-table-to-collect-cell-type-connectivity" class="level3">
<h3 class="anchored" data-anchor-id="pivot-the-synapse-table-to-collect-cell-type-connectivity">Pivot the synapse table to collect cell type connectivity</h3>
<p>Using <code>pandas.pivot()</code> on the pre- and post-synaptic cell classes, we count the number of connections between:</p>
<div id="a4d027de-8e66-48dc-b998-144e6832a3ba" class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Pivot table to get connectivity between cell types</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>syn_ct_counts <span class="op">=</span> (syn_proof_ct_df.pivot_table(index<span class="op">=</span><span class="st">'cell_type_pre'</span>,</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>                                             columns<span class="op">=</span><span class="st">'cell_type_post'</span>,</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>                                             values<span class="op">=</span><span class="st">'id'</span>, aggfunc<span class="op">=</span><span class="kw">lambda</span> x: <span class="bu">len</span>(x)).fillna(<span class="dv">0</span>)</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>                 .drop(columns<span class="op">=</span>[<span class="st">'Unsure E'</span>,<span class="st">'Unsure I'</span>,<span class="st">'unknown'</span>], index<span class="op">=</span>[<span class="st">'Unsure E'</span>,<span class="st">'Unsure I'</span>,<span class="st">'unknown'</span>])</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>                 .astype(<span class="bu">int</span>) </span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort by names</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>syn_ct_counts <span class="op">=</span> syn_ct_counts.reindex(<span class="bu">sorted</span>(syn_ct_counts.columns), axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>syn_ct_counts <span class="op">=</span> syn_ct_counts.reindex(<span class="bu">sorted</span>(syn_ct_counts.index), axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a><span class="co"># consistent axis naming</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>syn_ct_counts <span class="op">=</span> syn_ct_counts.rename_axis([<span class="st">'presyn cell type'</span>], axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>syn_ct_counts <span class="op">=</span> syn_ct_counts.rename_axis([<span class="st">'postsyn cell type'</span>], axis<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="plot-cell-connectivity-aggregated-by-cell-type" class="level3">
<h3 class="anchored" data-anchor-id="plot-cell-connectivity-aggregated-by-cell-type">Plot cell connectivity, aggregated by cell type</h3>
<p>This now summarizes connectivity between broad cell classes</p>
<div id="7a35b52f-974c-4ea6-ad78-4419c7abb3c8" class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">7</span>, <span class="dv">5</span>), dpi<span class="op">=</span><span class="dv">150</span>)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>sns.heatmap(syn_ct_counts, cmap<span class="op">=</span><span class="st">"gist_heat_r"</span>, annot<span class="op">=</span><span class="va">True</span>, ax<span class="op">=</span>ax, fmt<span class="op">=</span><span class="st">'d'</span>, vmin<span class="op">=</span><span class="dv">0</span>, vmax<span class="op">=</span><span class="dv">15000</span>,</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>            cbar_kws<span class="op">=</span>{<span class="st">'label'</span>: <span class="st">'synapses'</span>, <span class="st">'location'</span>: <span class="st">'right'</span>},</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>            annot_kws<span class="op">=</span>{<span class="st">"fontsize"</span>:<span class="dv">6</span>},</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>            square<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>ax.tick_params(left<span class="op">=</span><span class="va">False</span>, bottom<span class="op">=</span><span class="va">False</span>) </span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>ax.hlines([<span class="dv">8</span>], <span class="op">*</span>ax.get_xlim(), color<span class="op">=</span><span class="st">'white'</span>,linewidth <span class="op">=</span> <span class="dv">3</span>)</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>ax.vlines([<span class="dv">8</span>], <span class="op">*</span>ax.get_ylim(), color<span class="op">=</span><span class="st">'white'</span>,linewidth <span class="op">=</span> <span class="dv">3</span>)</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Aggregate Connectivity between proofread cells </span><span class="ch">\n</span><span class="st"> (cell type manually labeled)'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="49">
<pre><code>Text(0.5, 1.0, 'Aggregate Connectivity between proofread cells \n (cell type manually labeled)')</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="04-cave-query-synapses_files/figure-html/cell-26-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<h3 class="anchored">
Final note
</h3>
<p>It is worth keeping in mind that this connectivity matrix is highly dependendant on:</p>
<ol type="1">
<li>Which set of cell-type labels you include (here: manual labels in the V1 column)</li>
<li>Which set of proofread cells you include (here: most strict inclusion for pre- and post-synaptic partners)</li>
</ol>
<p>The more cells are proofread in the dataset, the more consistency and reproducibility you will get from connecitivty diagrams. See <a href="..\vortex-overview.html">VORTEX program</a> to request specific proofreading.</p>


</section>
</section>

<a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/tutorial\.microns-explorer\.org");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>Contributions by: Bethanny Danskin, Ben Pedigo, Casey Schneider-Mizell, Forrest Collman, Leila Elabbady, Sven Dorkenwald</p>
<div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.dev/AllenInstitute/microns_tutorial/blob/main/tutorial_book/quickstart_notebooks/04-cave-query-synapses.ipynb" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/AllenInstitute/microns_tutorial/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>